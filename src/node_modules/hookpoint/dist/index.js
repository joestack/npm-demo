"use strict";var g=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var x=(o,e)=>{for(var t in e)g(o,t,{get:e[t],enumerable:!0})},R=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of h(e))!A.call(o,n)&&n!==t&&g(o,n,{get:()=>e[n],enumerable:!(r=l(e,n))||r.enumerable});return o};var I=o=>R(g({},"__esModule",{value:!0}),o);var b={};x(b,{Hook:()=>i,HookCancel:()=>d,LastOutHook:()=>T,SeriesHook:()=>c,WaterfallHook:()=>p});module.exports=I(b);var d=Symbol.for("HookCancel");var u=class{constructor(){this.items=new Set}hasItem(e){return Array.from(this.items).some(t=>t.id===e)}add(...e){for(let t of e)this.ensureUniqueId(t),this.items.add(t);this.sortedItems=void 0}ensureUniqueId(e){e.id||(e.id="unknown");let t=e.id,r=1;for(;Array.from(this.items).some(n=>n.id===e.id&&n!==e);)e.id=`${t}#${r++}`}addSortSet(e){for(let t of e.items)this.ensureUniqueId(t),this.items.add(t);this.sortedItems=void 0}remove(e){let t=Array.from(this.items).find(r=>r.id===e);return t?(this.items.delete(t),this.sortedItems=void 0,!0):!1}get sorted(){if(!this.sortedItems){let e=this.calculateIndex(this.prepareSortItems());this.sortedItems=e.sort((t,r)=>t.index<r.index?-1:t.index>r.index?1:0).map(t=>t.item)}return this.sortedItems}prepareSortItems(){let e=[],t=new Map(Array.from(this.items).map(n=>[n.id,{id:n.id,after:[],item:n}])),r=[];for(let n of this.items){let s=t.get(n.id);if(s){if(n.after)for(let f of n.after){let a=t.get(f);a&&s.after.push(a)}n.before?r.push(s):e.push(s)}}for(let n of r){let s=[];if(n.item.before)for(let f of n.item.before){let a=t.get(f);a&&(a.after.splice(0,0,n),s.push(e.findIndex(m=>m.id===f)))}e.splice(Math.min(...s),0,n)}return e}calculateIndex(e){let t=[];for(let r of e)t.push({...r,index:this.getIndex(r,e)});return t}getIndex(e,t){if(typeof e.index>"u")if(e.after.length===0)e.index=t.indexOf(e)*2;else{e.index=-1;let r=e.after.map(n=>this.getIndex(n,t)).filter(n=>n>=0);r.length>0&&(e.index=Math.max(...r)+1)}return e.index}};var i=class{constructor(e){this.bailOut=e;this.id=this.constructor.name,this.#e=new u,this.#t=new u}#e;#t;get interceptors(){return[...this.#t.sorted]}get items(){return[...this.#e.sorted]}hasHook(e){return this.#e.hasItem(e)}addHook(e,t,r){let n={...r,id:e,action:t};this.#e.add(n)}addObjHook(e,...t){this.#e.add(...t.map(r=>({...r,id:r.id,action:(...n)=>e(r).call(r,...n)})))}removeHook(e){return this.#e.remove(e)}addInterceptor(e){this.#t.add(e)}removeInterceptor(e){return this.#t.remove(e)}async trigger(...e){let t=[],r={index:0,length:this.#e.sorted.length,args:e,results:t,hook:this};try{if(await this.intercept(n=>n.beforeLoop,r)===!1)return d;if(!r.bail)for(;r.index<r.length;){if(r.hookItem=this.#e.sorted[r.index],await this.intercept(s=>s.beforeTrigger,r)===!1)return d;if(r.bail){r.bail=!0;break}let n=await r.hookItem.action(...r.args);if(n===d)return d;if(t.push(n),r.args=this.getNextArgs(n,r.args),await this.intercept(s=>s.afterTrigger,r)===!1)return d;if(r.bail||this.bailOut&&this.bailOut(n)){r.bail=!0;break}r.index++}return await this.intercept(n=>n.afterLoop,r)===!1?d:this.getMergedResults(t,r.args)}catch(n){throw await this.intercept(s=>s.onError,n,r),n}}async intercept(e,...t){for(let r of this.#t.sorted){let n=e(r);if(n&&!await n.apply(r,t))return!1}return!0}add(...e){for(let t of e)this.#e.addSortSet(t.#e),this.#t.addSortSet(t.#t)}merge(...e){let t=this.initNew();return t.#e.addSortSet(this.#e),t.#t.addSortSet(this.#t),t.add(...e),t}};var T=class o extends i{constructor(e){super(e)}getNextArgs(e,t){return t}getMergedResults(e){return e.pop()}initNew(){return new o(this.bailOut)}};var c=class o extends i{constructor(e){super(e)}getNextArgs(e,t){return t}getMergedResults(e){return e}initNew(){return new o(this.bailOut)}};var p=class o extends i{constructor(e){super(e)}getNextArgs(e,t){return t[0]=e,t}getMergedResults(e,t){return e.length>0?e.pop():t[0]}initNew(){return new o(this.bailOut)}};0&&(module.exports={Hook,HookCancel,LastOutHook,SeriesHook,WaterfallHook});
//# sourceMappingURL=index.js.map
